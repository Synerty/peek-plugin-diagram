webpackJsonp([1],{0:function(t,e,o){t.exports=o("x35b")},ByoY:function(t,e){var o=CanvasRenderingContext2D.prototype;o.roundRect=function(t,e,o,n,r){var i=t+o,s=e+n,c=Math.PI/180;i-t-2*r<0&&(r=(i-t)/2),s-e-2*r<0&&(r=(s-e)/2),this.beginPath(),this.moveTo(t+r,e),this.lineTo(i-r,e),this.arc(i-r,e+r,r,270*c,360*c,!1),this.lineTo(i,s-r),this.arc(i-r,s-r,r,0*c,90*c,!1),this.lineTo(t+r,s),this.arc(t+r,s-r,r,90*c,180*c,!1),this.lineTo(t,e+r),this.arc(t+r,e+r,r,180*c,270*c,!1),this.closePath()},o.dashedLine=function(t,e,o,n,r){this.moveTo(t,e);for(var i=o-t,s=n-e,c=Math.floor(Math.sqrt(i*i+s*s)/r),a=i/c,l=s/c,u=0;u++<c;)t+=a,e+=l,this[u%2==0?"moveTo":"lineTo"](t,e);this[u%2==0?"moveTo":"lineTo"](o,n)},o.dashedRect=function(t,e,o,n,r){if(0==r)this.beginPath(),this.rect(t,e,o,n),this.closePath();else{this.beginPath();var i=t+o,s=e+n;this.dashedLine(t,e,i,e,r),this.dashedLine(i,e,i,s,r),this.dashedLine(i,s,t,s,r),this.dashedLine(t,s,t,e,r),this.closePath()}}},EMtb:function(t,e){t.exports='<div>\n    <p class="canvas-status-bar ">{{mouseInfo()}}</p>\n\n    <canvas #canvas class="canvas " >\n        Sorry, your browser doesn\'t support the &lt;canvas&gt; element.\n    </canvas>\n</div>\n'},Jnfr:function(t,e){function o(t){return Promise.resolve().then(function(){throw new Error("Cannot find module '"+t+"'.")})}o.keys=function(){return[]},o.resolve=o,t.exports=o,o.id="Jnfr"},P3hm:function(t,e){t.exports='\n<pl-diagram-canvas *ngIf="modelSetKey != null" [modelSetKey]="modelSetKey"></pl-diagram-canvas>'},hlov:function(t,e){t.exports=".canvas-status-bar {\n  z-index: 3;\n  position: absolute;\n  margin: 0 auto;\n  color: grey;\n  right: 10px; }\n\ncanvas {\n  width: 100%;\n  z-index: 1; }\n"},uslO:function(t,e,o){var n={"./af":"3CJN","./af.js":"3CJN","./ar":"3MVc","./ar-dz":"tkWw","./ar-dz.js":"tkWw","./ar-kw":"j8cJ","./ar-kw.js":"j8cJ","./ar-ly":"wPpW","./ar-ly.js":"wPpW","./ar-ma":"dURR","./ar-ma.js":"dURR","./ar-sa":"7OnE","./ar-sa.js":"7OnE","./ar-tn":"BEem","./ar-tn.js":"BEem","./ar.js":"3MVc","./az":"eHwN","./az.js":"eHwN","./be":"3hfc","./be.js":"3hfc","./bg":"lOED","./bg.js":"lOED","./bm":"hng5","./bm.js":"hng5","./bn":"aM0x","./bn.js":"aM0x","./bo":"w2Hs","./bo.js":"w2Hs","./br":"OSsP","./br.js":"OSsP","./bs":"aqvp","./bs.js":"aqvp","./ca":"wIgY","./ca.js":"wIgY","./cs":"ssxj","./cs.js":"ssxj","./cv":"N3vo","./cv.js":"N3vo","./cy":"ZFGz","./cy.js":"ZFGz","./da":"YBA/","./da.js":"YBA/","./de":"DOkx","./de-at":"8v14","./de-at.js":"8v14","./de-ch":"Frex","./de-ch.js":"Frex","./de.js":"DOkx","./dv":"rIuo","./dv.js":"rIuo","./el":"CFqe","./el.js":"CFqe","./en-au":"Sjoy","./en-au.js":"Sjoy","./en-ca":"Tqun","./en-ca.js":"Tqun","./en-gb":"hPuz","./en-gb.js":"hPuz","./en-ie":"ALEw","./en-ie.js":"ALEw","./en-il":"QZk1","./en-il.js":"QZk1","./en-nz":"dyB6","./en-nz.js":"dyB6","./eo":"Nd3h","./eo.js":"Nd3h","./es":"LT9G","./es-do":"7MHZ","./es-do.js":"7MHZ","./es-us":"INcR","./es-us.js":"INcR","./es.js":"LT9G","./et":"XlWM","./et.js":"XlWM","./eu":"sqLM","./eu.js":"sqLM","./fa":"2pmY","./fa.js":"2pmY","./fi":"nS2h","./fi.js":"nS2h","./fo":"OVPi","./fo.js":"OVPi","./fr":"tzHd","./fr-ca":"bXQP","./fr-ca.js":"bXQP","./fr-ch":"VK9h","./fr-ch.js":"VK9h","./fr.js":"tzHd","./fy":"g7KF","./fy.js":"g7KF","./gd":"nLOz","./gd.js":"nLOz","./gl":"FuaP","./gl.js":"FuaP","./gom-latn":"+27R","./gom-latn.js":"+27R","./gu":"rtsW","./gu.js":"rtsW","./he":"Nzt2","./he.js":"Nzt2","./hi":"ETHv","./hi.js":"ETHv","./hr":"V4qH","./hr.js":"V4qH","./hu":"xne+","./hu.js":"xne+","./hy-am":"GrS7","./hy-am.js":"GrS7","./id":"yRTJ","./id.js":"yRTJ","./is":"upln","./is.js":"upln","./it":"FKXc","./it.js":"FKXc","./ja":"ORgI","./ja.js":"ORgI","./jv":"JwiF","./jv.js":"JwiF","./ka":"RnJI","./ka.js":"RnJI","./kk":"j+vx","./kk.js":"j+vx","./km":"5j66","./km.js":"5j66","./kn":"gEQe","./kn.js":"gEQe","./ko":"eBB/","./ko.js":"eBB/","./ky":"6cf8","./ky.js":"6cf8","./lb":"z3hR","./lb.js":"z3hR","./lo":"nE8X","./lo.js":"nE8X","./lt":"/6P1","./lt.js":"/6P1","./lv":"jxEH","./lv.js":"jxEH","./me":"svD2","./me.js":"svD2","./mi":"gEU3","./mi.js":"gEU3","./mk":"Ab7C","./mk.js":"Ab7C","./ml":"oo1B","./ml.js":"oo1B","./mn":"CqHt","./mn.js":"CqHt","./mr":"5vPg","./mr.js":"5vPg","./ms":"ooba","./ms-my":"G++c","./ms-my.js":"G++c","./ms.js":"ooba","./mt":"oCzW","./mt.js":"oCzW","./my":"F+2e","./my.js":"F+2e","./nb":"FlzV","./nb.js":"FlzV","./ne":"/mhn","./ne.js":"/mhn","./nl":"3K28","./nl-be":"Bp2f","./nl-be.js":"Bp2f","./nl.js":"3K28","./nn":"C7av","./nn.js":"C7av","./pa-in":"pfs9","./pa-in.js":"pfs9","./pl":"7LV+","./pl.js":"7LV+","./pt":"ZoSI","./pt-br":"AoDM","./pt-br.js":"AoDM","./pt.js":"ZoSI","./ro":"wT5f","./ro.js":"wT5f","./ru":"ulq9","./ru.js":"ulq9","./sd":"fW1y","./sd.js":"fW1y","./se":"5Omq","./se.js":"5Omq","./si":"Lgqo","./si.js":"Lgqo","./sk":"OUMt","./sk.js":"OUMt","./sl":"2s1U","./sl.js":"2s1U","./sq":"V0td","./sq.js":"V0td","./sr":"f4W3","./sr-cyrl":"c1x4","./sr-cyrl.js":"c1x4","./sr.js":"f4W3","./ss":"7Q8x","./ss.js":"7Q8x","./sv":"Fpqq","./sv.js":"Fpqq","./sw":"DSXN","./sw.js":"DSXN","./ta":"+7/x","./ta.js":"+7/x","./te":"Nlnz","./te.js":"Nlnz","./tet":"gUgh","./tet.js":"gUgh","./tg":"5SNd","./tg.js":"5SNd","./th":"XzD+","./th.js":"XzD+","./tl-ph":"3LKG","./tl-ph.js":"3LKG","./tlh":"m7yE","./tlh.js":"m7yE","./tr":"k+5o","./tr.js":"k+5o","./tzl":"iNtv","./tzl.js":"iNtv","./tzm":"FRPF","./tzm-latn":"krPU","./tzm-latn.js":"krPU","./tzm.js":"FRPF","./ug-cn":"To0v","./ug-cn.js":"To0v","./uk":"ntHu","./uk.js":"ntHu","./ur":"uSe8","./ur.js":"uSe8","./uz":"XU1s","./uz-latn":"/bsm","./uz-latn.js":"/bsm","./uz.js":"XU1s","./vi":"0X8Q","./vi.js":"0X8Q","./x-pseudo":"e/KL","./x-pseudo.js":"e/KL","./yo":"YXlc","./yo.js":"YXlc","./zh-cn":"Vz2w","./zh-cn.js":"Vz2w","./zh-hk":"ZUyn","./zh-hk.js":"ZUyn","./zh-tw":"BbgG","./zh-tw.js":"BbgG"};function r(t){return o(i(t))}function i(t){var e=n[t];if(!(e+1))throw new Error("Cannot find module '"+t+"'.");return e}r.keys=function(){return Object.keys(n)},r.resolve=i,t.exports=r,r.id="uslO"},x35b:function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n,r=o("WT6e"),i=o("4PVY"),s=o("OE0E"),c=o("eSGZ"),a=function(){return function(t,e,o){var n=this;this.lifeCycleEvents=t,this.service=e,this.iface=o;var r=e;this.iface.on("positionSubject",function(t){console.log("WEB: Received positionSubject event"),e.position(t.coordSetKey,t.x,t.y,t.zoom)}),this.iface.on("positionByCoordSetObservable",function(t){console.log("WEB: Received positionByCoordSetObservable event"),e.positionByCoordSet(t)}),t.onDestroyEvent.subscribe(function(){n.iface.off("positionSubject"),n.iface.off("positionByCoordSetObservable")}),r.isReadyObservable().takeUntil(t.onDestroyEvent).subscribe(function(t){console.log("WEB: Sending isReadySubject "+t),o.emit("isReadySubject",t)}),r.positionUpdatedObservable().takeUntil(t.onDestroyEvent).subscribe(function(t){console.log("WEB: Sending positionUpdated"),o.emit("positionUpdated",t)}),r.titleUpdatedObservable().takeUntil(t.onDestroyEvent).subscribe(function(t){console.log("WEB: Sending titleUpdatedSubject "+t),o.emit("titleUpdatedSubject",t)})}}(),l=function(){return function(t,e,o){this.lifeCycleEvents=t,this.service=e,this.iface=o,e.itemSelectObservable().takeUntil(t.onDestroyEvent).subscribe(function(t){console.log("WEB: Sending itemSelect event"),o.emit("itemSelected",t)})}}(),u=function(){return function(){}}(),f=o("g5jc"),h=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},p=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},d=function(){function t(){this.itemSelectSubject=new f.Subject}return t.prototype.itemSelectObservable=function(){return this.itemSelectSubject},t.prototype.selectItem=function(t){this.itemSelectSubject.next(t)},t=h([Object(r.Injectable)(),p("design:paramtypes",[])],t)}(),y=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])},function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),v=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},_=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},g=function(t){function e(e,o,n){var r=t.call(this)||this;return r.vortexService=e,r.positionService=o,r.itemSelectService=n,r.modelSetKey=null,r.itemSelectServiceBridge=null,r.positionServiceBridge=null,r}return y(e,t),e.prototype.ngOnInit=function(){var t={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,o,n){return t[o]=n}),this.modelSetKey=t.modelSetKey;var e=t.vortexWsUrl;if(null!=e&&(c.VortexService.setVortexUrl(e),this.vortexService.reconnect()),null==this.modelSetKey||0==this.modelSetKey.length)throw alert("modelSetKey set is empty or null"),new Error("modelSetKey set is empty or null");this.oWebViewInterface=window.nsWebViewInterface,this.itemSelectServiceBridge=new l(this,this.itemSelectService,this.oWebViewInterface),this.positionServiceBridge=new a(this,this.positionService,this.oWebViewInterface)},e=v([Object(r.Component)({selector:"ns-web-diagram",template:o("P3hm")}),_("design:paramtypes",[c.VortexService,u,d])],e)}(c.ComponentLifecycleEventEmitter),m=o("Xjw4"),b=o("w9zx");o("ByoY");function S(t,e){void 0===e&&(e=!1);var o=[];for(var n in t)n.startsWith("_")&&!e||!t.hasOwnProperty(n)||"function"==typeof n||o.push(n);return o}function w(t){var e=[];for(var o in t)o.startsWith("_")||e.push(t[o]);return e}var O=function(){function t(t){this.message=t}return t.prototype.toString=function(){return"AssertException: "+this.message},t}();function j(t,e){if(!t)throw console.trace(),new O(e)}var P,x={plugin:"peek_plugin_diagram"},R="peek_plugin_diagram.",T="peek_plugin_diagram",E="peek_plugin_diagram",D="peek_plugin_diagram",C="peek_plugin_diagram_grids",I="peek_plugin_diagram_location_index",B=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),k=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},G=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},L=(function(t){function e(){return t.call(this,o.tupleName)||this}return B(e,t),o=e,e.tupleName=R+"DiagramLoaderStatusTuple",e=o=k([c.addTupleType,G("design:paramtypes",[])],e);var o}(c.Tuple),this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}()),A=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},N=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},M=(function(t){function e(){return t.call(this,o.tupleName)||this}return L(e,t),o=e,e.tupleName=R+"SettingProperty",e=o=A([c.addTupleType,N("design:paramtypes",[])],e);var o}(c.Tuple),this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}()),K=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},U=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},z=function(t){function e(){return t.call(this,o.tupleName)||this}return M(e,t),o=e,e.tupleName=R+"DispLevel",e=o=K([c.addTupleType,U("design:paramtypes",[])],e);var o}(c.Tuple),F=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),W=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},V=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},H=function(t){function e(){return t.call(this,o.tupleName)||this}return F(e,t),o=e,e.tupleName=R+"DispLayer",e=o=W([c.addTupleType,V("design:paramtypes",[])],e);var o}(c.Tuple),X=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Z=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},q=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Y=function(t){function e(){return t.call(this,o.tupleName)||this}return X(e,t),o=e,e.tupleName=R+"DispColor",e=o=Z([c.addTupleType,q("design:paramtypes",[])],e);var o}(c.Tuple),J=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Q=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},$=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},tt=function(t){function e(){return t.call(this,o.tupleName)||this}return J(e,t),o=e,e.tupleName=R+"DispTextStyle",e=o=Q([c.addTupleType,$("design:paramtypes",[])],e);var o}(c.Tuple),et=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ot=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},nt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},rt=function(t){function e(){var e=t.call(this,o.tupleName)||this;return e.CAP_BUTT="butt",e.CAP_ROUND="round",e.CAP_SQUARE="square",e.JOIN_BEVEL="bevel",e.JOIN_ROUND="round",e.JOIN_MITER="miter",e}return et(e,t),o=e,e.tupleName=R+"DispLineStyle",e=o=ot([c.addTupleType,nt("design:paramtypes",[])],e);var o}(c.Tuple),it=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},st=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},ct=function(){function t(t,e,o,n,r){var i=new c.TupleDataObservableNameService(T,x),s=new c.TupleOfflineStorageNameService(D),a=new c.TupleActionPushNameService(E,x),l=new c.TupleOfflineStorageService(n,s);this.tupleObserver=new c.TupleDataObserverService(e,o,r,i),this.tupleOfflineObserver=new c.TupleDataOfflineObserverService(e,o,r,i,l),this.tupleOfflineAction=new c.TupleActionPushOfflineService(a,e,o,t)}return t=it([Object(r.Injectable)(),st("design:paramtypes",[c.TupleActionPushOfflineSingletonService,c.VortexService,c.VortexStatusService,c.TupleStorageFactoryService,r.NgZone])],t)}(),at=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},lt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},ut=function(){function t(t){this.tupleService=t,this.modelSetKey="",this.loadedCounter={},this._lookupTargetCount=5,this._levelsById={},this._layersById={},this._colorsById={},this._textStyleById={},this._lineStyleById={},this._levelsByCoordSetIdOrderedByOrder={},this._layersOrderedByOrder=[],this.subscriptions=[],this._isReady=!1}return t.prototype.setModelSetKey=function(t){this.modelSetKey=t,this.initialLoad()},t.prototype.initialLoad=function(){var t=this,e=function(e,o,n){void 0===n&&(n=null),t.subscriptions.push(t.tupleService.offlineObserver.subscribeToTupleSelector(new c.TupleSelector(o,{modelSetKey:t.modelSetKey})).subscribe(function(o){if(o.length){t.loadedCounter[e]=!0,t[e]={};for(var r=0; r<o.length; r++){var i=o[r];t[e][i.id]=i}null!=n&&n()}}))};e("_levelsById",z.tupleName,function(){return t.createLevelsOrderedByOrder()}),e("_layersById",H.tupleName,function(){return t.createLayersOrderedByOrder()}),e("_colorsById",Y.tupleName,function(){return t._validateColors()}),e("_textStyleById",tt.tupleName),e("_lineStyleById",rt.tupleName,function(){return t._convertLineStyleDashPattern()})},t.prototype.isReady=function(){if(this._isReady)return!0;var t=S(this.loadedCounter,!0).length;return this._lookupTargetCount==t&&(this._isReady=!0,!0)},t.prototype.shutdown=function(){for(var t=0,e=this.subscriptions;t<e.length;t++){e[t].unsubscribe()}this.subscriptions=[]},t.prototype._validateColors=function(){function t(t){if(""===t)return!1;if("inherit"===t)return!1;if("transparent"===t)return!1;var e=document.createElement("img");return e.style.color="rgb(0, 0, 0)",e.style.color=t,"rgb(0, 0, 0)"!==e.style.color||(e.style.color="rgb(255, 255, 255)",e.style.color=t,"rgb(255, 255, 255)"!==e.style.color)}for(var e=w(this._colorsById),o=0;o<e.length;o++){var n=e[o];t(n.color)||(console.log("Color "+n.color+" is not a valid CSS color"),n.color="green")}},t.prototype.levelForId=function(t){return this._levelsById[t]},t.prototype.layerForId=function(t){return this._layersById[t]},t.prototype.colorForId=function(t){return this._colorsById[t]},t.prototype.textStyleForId=function(t){return this._textStyleById[t]},t.prototype.lineStyleForId=function(t){return this._lineStyleById[t]},t.prototype.layersOrderedByOrder=function(){return this._layersOrderedByOrder},t.prototype.levelsOrderedByOrder=function(t){var e=this._levelsByCoordSetIdOrderedByOrder[t];return null==e?[]:e},t.prototype.createLayersOrderedByOrder=function(){this._layersOrderedByOrder=w(this._layersById).sort(function(t,e){return t.order-e.order})},t.prototype.createLevelsOrderedByOrder=function(){var t={};this._levelsByCoordSetIdOrderedByOrder=t;for(var e=w(this._levelsById).sort(function(t,e){return t.order-e.order}),o=0;o<e.length;o++){var n=e[o];null==t[n.coordSetId]&&(t[n.coordSetId]=[]),t[n.coordSetId].push(n)}},t.prototype._convertLineStyleDashPattern=function(){for(var t=0,e=w(this._lineStyleById);t<e.length;t++){var o=e[t];null!=o.dashPattern&&(o.dashPattern=JSON.parse(""+o.dashPattern))}},t.prototype.linkDispLookups=function(t){return null!=t.le&&(t.lel=this._levelsById[t.le],null==t.lel)?null:null!=t.la&&(t.lal=this._layersById[t.la],null==t.lal)?null:null!=t.fs&&(t.fsl=this._textStyleById[t.fs],null==t.fsl)?null:null!=t.c&&(t.cl=this._colorsById[t.c],null==t.cl)?null:null!=t.lc&&(t.lcl=this._colorsById[t.lc],null==t.lcl)?null:null!=t.fc&&(t.fcl=this._colorsById[t.fc],null==t.fcl)?null:null!=t.ls&&(t.lsl=this._lineStyleById[t.ls],null==t.lsl)?null:t},t=at([Object(r.Injectable)(),lt("design:paramtypes",[ct])],t)}(),ft=function(){function t(t,e){if(void 0===e&&(e=null),this.gridKey=null,this.lastUpdate=null,this.loadedFromServerDate=new Date,this.disps=[],"string"!=typeof t){var o=t;j(null!=e,"lookupStore can not be null"),this.gridKey=o.gridKey,this.lastUpdate=o.lastUpdate,this.loadedFromServerDate=new Date,this.disps=[];var n=[];if(null!=o.dispJsonStr&&0!=o.dispJsonStr.length)try{n=JSON.parse(o.dispJsonStr)}catch(t){console.error(t.toString())}for(var r=0;r<n.length;r++){var i=n[r];null!=i.id&&(null!=e.linkDispLookups(i)&&this.disps.push(i))}}else this.gridKey=t}return t.prototype.hasData=function(){return!(null==this.lastUpdate&&0==this.disps.length)},t}(),ht=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),pt=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},dt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},yt=function(t){function e(){var e=t.call(this,o.tupleName)||this;return e._rawJonableFields=["data"],e.data={},e}return ht(e,t),o=e,e.tupleName=R+"GridUpdateDateTuple",e=o=pt([c.addTupleType,dt("design:paramtypes",[])],e);var o}(c.Tuple),vt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t, e){t.__proto__=e}||function(t, e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e, o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),_t=this&&this.__decorate||function(t, e, o, n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},gt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},mt=function(t){function e(){var e=t.call(this)||this;return e._isCachingInProgressSubject=new f.Subject,e._isCachingInProgress=!1,e._cacheProgressSubject=new f.Subject,e}return vt(e,t),Object.defineProperty(e.prototype,"cacheProgressObservable",{get:function(){return this._cacheProgressSubject},enumerable:!0,configurable:!0}),e.prototype.updateStatus=function(t){this._cacheProgressSubject.next(t)},e.prototype.updateInProgress=function(t){this._isCachingInProgress=t,this._isCachingInProgressSubject.next(t)},Object.defineProperty(e.prototype,"cachingRunningObservable",{get:function(){return this._isCachingInProgressSubject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cachingRunning",{get:function(){return this._isCachingInProgress},enumerable:!0,configurable:!0}),e=_t([Object(r.Injectable)(),gt("design:paramtypes",[])],e)}(c.ComponentLifecycleEventEmitter),bt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),St=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},wt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Ot=Object(c.extend)({key:"clientGridWatchUpdateFromDevice"},x),jt=function(t){function e(e){return t.call(this,e,{})||this}return bt(e,t),e.prototype.toOrderedJsonStr=function(){return this.name},e}(c.TupleSelector),Pt=function(t){function e(){return t.call(this)||this}return bt(e,t),e}(c.ComponentLifecycleEventEmitter),xt=(function(t){function e(e,o,n,r,i){var s=t.call(this)||this;return s.cacheStatusService=e,s.vortexService=o,s.vortexStatusService=n,s.tupleService=r,s.isReadySubject=new f.Subject,s.updatesObservable=new f.Subject,s.lastWatchedGridKeys=[],s.gridCacheIndex=new yt,s.cacheGridQueueChunks=[],s.chunksSavedSinceLastIndexSave=0,s.storage=i.create(new c.TupleOfflineStorageNameService(C)),s.storage.open().then(function(){return s.loadGridCacheIndex()}).then(function(){return s.isReadySubject.next(!0)}).catch(function(t){return console.log("Failed to open grid cache db "+t)}),s.vortexService.createEndpointObservable(s,Ot).subscribe(function(t){return s.processGridsFromServer(t)}),s.vortexStatusService.isOnline.filter(function(t){return 1==t}).takeUntil(s.onDestroyEvent).subscribe(function(){return s.loadGrids({},s.lastWatchedGridKeys)}),s}bt(e,t),e.prototype.isReady=function(){return this.storage.isOpen()},e.prototype.isReadyObservable=function(){return this.isReadySubject},Object.defineProperty(e.prototype,"observable",{get:function(){return this.updatesObservable},enumerable:!0,configurable:!0}),e.prototype.cacheAll=function(){var t=this;this.vortexStatusService.snapshot.isOnline&&(this.cacheStatusService.updateStatus("Starting Cache Update"),this.tupleService.tupleObserver.pollForTuples(new c.TupleSelector(yt.tupleName,{})).then(function(e){if(e.length){var o=e[0],n=[],r=0,i={};for(var s in o.data)if(o.data.hasOwnProperty(s)){var c=o.data[s],a=t.gridCacheIndex.data[s];null==a?(i[s]=null,r+=1):a!=c&&(i[s]=a,r+=1),15==r&&(n.push(i),r=0,i={})}r&&n.push(i),t.cacheGridQueueChunks=n,console.log("Cacheing "+t.cacheGridQueueChunks.length+" grid chunks"),t.cacheRequestNextChunk()}}).catch(function(t){return console.log("ERROR in cacheAll : "+t)}))},e.prototype.cacheRequestNextChunk=function(){if(this.chunksSavedSinceLastIndexSave++,0==this.cacheGridQueueChunks.length)return this.cacheStatusService.updateStatus("Caching Complete"),void this.saveGridCacheIndex(!0);this.saveGridCacheIndex(),this.cacheStatusService.updateStatus(this.cacheGridQueueChunks.length+" grids left"),console.log("Cacheing next grid chunk, "+this.cacheGridQueueChunks.length+" remaining");var t=this.cacheGridQueueChunks.pop(),e=new c.Payload(Object(c.extend)({cacheAll:!0},Ot));e.tuples=[t],this.vortexService.sendPayload(e)},e.prototype.watchGrids=function(t){this.lastWatchedGridKeys=t},e.prototype.loadGrids=function(t,e){var o=this;this.queryStorageGrids(e).then(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t[i.gridKey]=i.lastUpdate}o.sendWatchedGridsToServer(t)})},e.prototype.sendWatchedGridsToServer=function(t){if(this.vortexStatusService.snapshot.isOnline){var e=new c.Payload(Ot);e.tuples=[t],this.vortexService.sendPayload(e)}},e.prototype.processGridsFromServer=function(t){var e=this;t.decodePayload().then(function(t){var o=t.tuples,n=!0===t.filt.cacheAll;return n||e.emitEncodedGridTuples(o),e.storeGridTuples(o).then(function(){return n&&e.cacheRequestNextChunk()})}).catch(function(t){return"ERROR PrivateDiagramGridLoaderService.processGridsFromServer: "+t})},e.prototype.emitEncodedGridTuples=function(t){for(var e=this,o=[],n=[],r=0,i=t;r<i.length;r++){var s=i[r],a=c.Payload.fromEncodedPayload(s.encodedGridTuple).then(function(t){n.push(t.tuples[0])}).catch(function(t){console.log("PrivateDiagramGridLoaderService.emitEncodedGridTuples decode error: "+t)});o.push(a)}Promise.all(o).then(function(){e.updatesObservable.next(n)}).catch(function(t){console.log("PrivateDiagramGridLoaderService.emitEncodedGridTuples all error: "+t)})},e.prototype.queryStorageGrids=function(t){var e=this;return this.storage.transaction(!1).then(function(o){for(var n=[],r=[],i=0,s=t; i<s.length; i++){var c=s[i];n.push(o.loadTuples(new jt(c)).then(function(t){t.length&&(r.push(t[0]),e.updatesObservable.next(t))}))}return Promise.all(n).then(function(){return o.close().catch(function(t){return console.log("GridCache.queryStorageGrids commit:"+t)}),r})})},e.prototype.storeGridTuples=function(t){var e=this;if(0==t.length)return Promise.resolve();for(var o=[],n=0,r=t;n<r.length;n++){var i=r[n];o.push(i.gridKey)}return console.log("Caching grids "+o),this.storage.transaction(!0).then(function(o){for(var n=[],r=0,i=t;r<i.length;r++){var s=i[r];e.gridCacheIndex.data[s.gridKey]=s.lastUpdate,n.push(o.saveTuplesEncoded(new jt(s.gridKey),s.encodedGridTuple))}return Promise.all(n).then(function(){return e.saveGridCacheIndex(!1,o)}).then(function(){return o.close()}).catch(function(t){return console.log("GridCache.storeGridTuples: "+t)})})},e.prototype.loadGridCacheIndex=function(){var t=this;return this.storage.transaction(!1).then(function(e){return e.loadTuples(new c.TupleSelector(yt.tupleName,{})).then(function(e){e.length&&(t.gridCacheIndex=e[0])})})},e.prototype.saveGridCacheIndex=function(t,e){if(void 0===t&&(t=!1),void 0===e&&(e=null),this.chunksSavedSinceLastIndexSave<=20&&!t)return Promise.resolve();var o=new c.TupleSelector(yt.tupleName,{}),n=[this.gridCacheIndex],r=function(t){return console.log("GridCache.storeGridCacheIndex: "+t)};return this.chunksSavedSinceLastIndexSave=0,null!=e?e.saveTuples(o,n).catch(r):this.storage.transaction(!0).then(function(t){return t.saveTuples(o,n)}).catch(r)},e=St([Object(r.Injectable)(),wt("design:paramtypes",[mt,c.VortexService,c.VortexStatusService,ct,c.TupleStorageFactoryService])],e)}(Pt),this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s}),Rt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Tt=(o("xe4/"),function(){function t(){this.cache={}}return t.prototype.put=function(t){this.cache[t.gridKey]=t},t.prototype.get=function(t){return this.has(t)?this.cache[t]:null},t.prototype.del=function(t){delete this.cache[t]},t.prototype.has=function(t){return this.cache.hasOwnProperty(t)},t}()),Et=function(){function t(t,e){var o=this;this.lookupCache=t,this.gridLoader=e,this.updatesObservable=new f.Subject,this.cacheQueue=[],this.MAX_CACHE=50,this.lifecycleEmitter=new c.ComponentLifecycleEventEmitter,this.gridLoader.observable.takeUntil(this.lifecycleEmitter.onDestroyEvent).subscribe(function(t){return o.processGridUpdates(t)})}return t.prototype.isReady=function(){return this.gridLoader.isReady()},Object.defineProperty(t.prototype,"observable",{get:function(){return this.updatesObservable},enumerable:!0,configurable:!0}),t.prototype.updateWatchedGrids=function(t){this.gridLoader.watchGrids(t);for(var e=this.rotateCache(t),o=0,n=w(e);o<n.length;o++){var r=n[o];this.updatesObservable.next(r)}for(var i=[],s={},c=0,a=t;c<a.length;c++){var l=a[c],u=e.get(l);s[l]=null==u?null:u.lastUpdate,null==u&&i.push(l)}this.gridLoader.loadGrids(s,i)},t.prototype.rotateCache=function(t){for(var e=new Tt,o=0,n=t;o<n.length;o++)for(var r=n[o],i=0,s=this.cacheQueue;i<s.length;i++){var c=s[i],a=!1;if(!a){var l=c.get(r);null!=l&&(e[r]=l,a=!0)}c.del(r)}for(this.cacheQueue.unshift(e);this.cacheQueue.length>this.MAX_CACHE;)this.cacheQueue.pop();return e},t.prototype.processGridUpdates=function(t){for(var e=this.cacheQueue[0],o=0,n=t;o<n.length;o++){var r=n[o],i=e[r.gridKey];if(null==i||i.lastUpdate!=r.lastUpdate){var s=new ft(r,this.lookupCache);e.put(s),this.updatesObservable.next(s)}}},t=xt([Object(r.Injectable)(),Rt("design:paramtypes",[ut,Pt])],t)}(),Dt=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},Ct=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},It=function(){function t(t){var e=this;this.gridCache=t,this.subjectByCanvasId={},this.gridKeysByCanvasId={},this.canvasIdsByGidKey={},this.lastObservedKeysStr="",this.gridCache.observable.subscribe(function(t){return e.processGridUpdates(t)})}return t.prototype.isReady=function(){return this.gridCache.isReady()},t.prototype.unsubscribeCanvas=function(t){delete this.gridKeysByCanvasId[t],delete this.subjectByCanvasId[t],this.rebuildReverseLookup(),this.updateGridCacheWatchedKeys()},t.prototype.observableForCanvas=function(t){return j(!this.subjectByCanvasId.hasOwnProperty(t),"Canvas "+t+" has already requested a subhect"),this.subjectByCanvasId[t]=new f.Subject,this.subjectByCanvasId[t]},t.prototype.updateDiagramWatchedGrids=function(t,e){this.gridKeysByCanvasId[t]=e,this.rebuildReverseLookup(),this.updateGridCacheWatchedKeys()},t.prototype.processGridUpdates=function(t){if(this.canvasIdsByGidKey.hasOwnProperty(t.gridKey))for(var e=0,o=this.canvasIdsByGidKey[t.gridKey];e<o.length;e++){var n=o[e];this.subjectByCanvasId[n].next(t)}},t.prototype.updateGridCacheWatchedKeys=function(){var t=S(this.canvasIdsByGidKey).sort(),e=t.join(",");this.lastObservedKeysStr!=e&&(this.lastObservedKeysStr=e,this.gridCache.updateWatchedGrids(t))},t.prototype.rebuildReverseLookup=function(){for(var t={},e=0,o=S(this.gridKeysByCanvasId);e<o.length;e++)for(var n=o[e],r=0,i=this.gridKeysByCanvasId[n];r<i.length;r++){var s=i[r],c=null;t.hasOwnProperty(s)?c=t[s]:t[s]=c=[],c.push(n)}this.canvasIdsByGidKey=t},t=Dt([Object(r.Injectable)(),Ct("design:paramtypes",[Et])],t)}(),Bt=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},kt=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Gt=function(){function t(){this.modelSetKey=""}return t.prototype.setModelSetKey=function(t){this.modelSetKey=t},t.prototype.dispGroupForId=function(t){return[]},t=Bt([Object(r.Injectable)(),kt("design:paramtypes",[])],t)}(),Lt=function(){function t(e,o,n,r){if(void 0===e&&(e=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===r&&(r=0),e instanceof t)return this.x=parseFloat(e.x.toString()),this.y=parseFloat(e.y.toString()),this.w=parseFloat(e.w.toString()),void(this.h=parseFloat(e.h.toString()));this.x=0,this.y=0,this.w=0,this.h=0,e&&(this.x=parseFloat(e.toString())),o&&(this.y=parseFloat(o.toString())),n&&(this.w=parseFloat(n.toString())),r&&(this.h=parseFloat(r.toString())),this.w<0&&(this.w*=-1,this.x=this.x-this.w),this.h<0&&(this.h*=-1,this.y=this.y-this.h)}return t.fromGeom=function(e){for(var o=new t,n=e[0],r=e[1],i=n,s=n,c=r,a=r,l=2;l<e.length;l+=2){var u=e[l],f=e[l+1];u<i&&(i=u),s<u&&(s=u),f<c&&(c=f),a<f&&(a=f)}return o.x=i,o.y=c,o.w=s-i,o.h=a-c,o},t.prototype.contains=function(t,e,o){var n=this,r=n.x-o/2,i=n.x+n.w+o/2,s=n.y-o/2,c=n.y+n.h+o/2;return r<=t&&t<=i&&s<=e&&e<=c},t.prototype.withIn=function(e,o,n,r){e instanceof t&&(o=e.y,n=e.w,r=e.h,e=e.x);var i=this;return e<=i.x&&i.x+i.w<=e+n&&o<=i.y&&i.y+i.h<=o+r},t.prototype.isEqual=function(e){return e instanceof t&&(this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h)},t.prototype.area=function(){return this.w*this.h},t.prototype.toString=function(){return this.x+"x,"+this.y+"y,"+this.w+"w,"+this.h+"h"},t}(),At=function(){function t(){this.controller={updateInterval:400,coordSetChange:new f.Subject,coordSet:null},this.renderer={invalidate:new f.Subject,drawInterval:60,backgroundColor:"black",selection:{color:"white",width:8,lineGap:6,dashLen:3,snapSize:4},grid:{show:!1,size:16,color:"#CCC",font:"12px Arial",lineWidth:1,snapDashedLen:2}},this.viewPort={windowChange:new f.Subject,window:new Lt,zoomChange:new f.Subject,panChange:new f.Subject,pan:{x:238255,y:124655},zoom:.5,minZoom:.01,maxZoom:10},this.canvas={windowChange:new f.Subject,window:new Lt},this.mouse={currentDelegateName:null,phUpDownZoomFactor:20,currentViewPortPosition:{x:0,y:0},currentCanvasPosition:{x:0,y:0},selecting:{color:"#3399FF",width:2,lineGap:2,dashLen:3,snapSize:4,margin:5}},this.model={gridsWaitingForData:0,dispOnScreen:0},this.debug={},this.canvasId=t.canvasIdCounter++}return t.prototype.invalidate=function(){this.renderer.invalidate.next()},t.prototype.updateViewPortPan=function(t){this.viewPort.pan=t,this.viewPort.panChange.next(t)},t.prototype.updateViewPortZoom=function(t){this.viewPort.zoom=t,this.viewPort.zoomChange.next(t)},t.prototype.updateViewPortWindow=function(t){this.viewPort.window=t,this.viewPort.windowChange.next(t)},t.prototype.updateCanvasWindow=function(t){this.canvas.window=t,this.canvas.windowChange.next(t)},t.prototype.updateCoordSet=function(t){this.controller.coordSet=t,this.controller.coordSetChange.next(t),this.viewPort.minZoom=t.minZoom,this.viewPort.maxZoom=t.maxZoom},t.canvasIdCounter=0,t}(),Nt=function(){return function(t){this.config=t}}(),Mt=function(){function t(){}return t.id=function(t){return t.id},t.level=function(t){return t.lel},t.layer=function(t){return t.lal},t.isSelectable=function(t){return t.s},t.key=function(t){return t.k},t.data=function(t){return null==t.d?{}:JSON.parse(t.d)},t}(),Kt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();!function(t){t[t.fillTopToBottom=0]="fillTopToBottom",t[t.fillBottomToTop=1]="fillBottomToTop",t[t.fillRightToLeft=2]="fillRightToLeft",t[t.fillLeftToRight=3]="fillLeftToRight"}(P||(P={}));var Ut,zt,Ft=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Kt(e,t),e.fillColor=function(t){return t.fcl},e.lineColor=function(t){return t.lcl},e.lineStyle=function(t){return t.lsl},e.cornerRadius=function(t){return t.cr},e.lineWidth=function(t){return t.w},e.geom=function(t){return t.g},e.fillDirection=function(t){var e=t.fd;return e==P.fillBottomToTop?P.fillBottomToTop:e==P.fillRightToLeft?P.fillRightToLeft:e==P.fillLeftToRight?P.fillLeftToRight:P.fillTopToBottom},e.fillPercent=function(t){return t.fp},e}(Mt),Wt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Vt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Wt(e,t),e.fillColor=function(t){return t.fcl},e.lineColor=function(t){return t.lcl},e.lineStyle=function(t){return t.lsl},e.lineWidth=function(t){return t.w},e.centerPointX=function(t){return t.g[0]},e.centerPointY=function(t){return t.g[1]},e.xRadius=function(t){return t.xr},e.yRadius=function(t){return t.yr},e.rotation=function(t){return t.r},e.startAngle=function(t){return t.sa},e.endAngle=function(t){return t.ea},e}(Mt),Ht=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();!function(t){t[t.top=-1]="top",t[t.center=0]="center",t[t.bottom=1]="bottom"}(Ut||(Ut={})),function(t){t[t.left=-1]="left",t[t.center=0]="center",t[t.right=1]="right"}(zt||(zt={}));var Xt,Zt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ht(e,t),e.textStyle=function(t){return t.fsl},e.color=function(t){return t.cl},e.verticalAlign=function(t){var e=t.va;return e==Ut.top?Ut.top:e==Ut.bottom?Ut.bottom:Ut.center},e.horizontalAlign=function(t){var e=t.ha;return e==zt.left?zt.left:e==zt.right?zt.right:zt.center},e.rotation=function(t){return t.r},e.text=function(t){return t.te},e.height=function(t){return t.th},e.horizontalStretch=function(t){return t.hs},e.centerPointX=function(t){return t.g[0]},e.centerPointY=function(t){return t.g[1]},e}(Mt),qt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Yt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.lineColor=function(t){return t.lcl},e.lineStyle=function(t){return t.lsl},e.lineWidth=function(t){return t.w},e.geom=function(t){return t.g},e.startKey=function(t){return t.sk},e.endKey=function(t){return t.ek},e}(Mt),Jt=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Qt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Jt(e,t),e}(Mt),$t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return $t(e,t),e.items=function(t){return t.items},e}(Mt);!function(t){t[t.ellipse=0]="ellipse",t[t.polygon=1]="polygon",t[t.polyline=2]="polyline",t[t.text=3]="text",t[t.group=4]="group",t[t.groupPointer=5]="groupPointer"}(Xt||(Xt={}));var ee=function(){function t(){}return t.type=function(e){return t.typeMap[e._tt][0]},t.wrapper=function(e){return t.typeMap[e._tt][1]},t.typeMap={DT:[Xt.text,Zt],DPG:[Xt.polygon,Ft],DPL:[Xt.polyline,Yt],DE:[Xt.ellipse,Vt],DG:[Xt.group,te],DGP:[Xt.groupPointer,Qt]},t}(),oe=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ne=function(t){function e(e){return t.call(this,e)||this}return oe(e,t),e.prototype._drawLine=function(t,e,o,n,r,i,s,c){if(null!=i){var a=i[c%i.length]/s;t.moveTo(e,o);for(var l=n-e,u=r-o,f=Math.floor(Math.sqrt(l*l+u*u)/a),h=l/f,p=u/f,d=0;d++<f;)e+=h,o+=p,t[d%2==0?"moveTo":"lineTo"](e,o);t[d%2==0?"moveTo":"lineTo"](n,r)}else t.lineTo(n,r)},e.prototype.draw=function(t,e,o,n){var r=ee.type(t)==Xt.polygon,i=r?Ft.fillColor(t):null,s=Ft.lineColor(t),c=Ft.lineStyle(t),a=null;if(null!=c&&null!=c.dashPattern&&(a=c.dashPattern),i=i&&i.color?i:null,s=c&&s&&s.color?s:null,i||s){var l=Ft.fillDirection(t),u=Ft.fillPercent(t),f=Ft.geom(t),h=f[0],p=f[1];if(s&&c.backgroundFillDashSpace&&a){e.beginPath(),e.moveTo(h,p);for(var d=2;d<f.length;d+=2){var y=f[d],v=f[d+1];e.lineTo(y,v)}e.strokeStyle=this.config.renderer.backgroundColor,e.lineWidth=Ft.lineWidth(t)/o,e.stroke()}e.beginPath(),e.moveTo(h,p);var _=h,g=p;for(d=2;d<f.length;d+=2){y=f[d],v=f[d+1];this._drawLine(e,_,g,y,v,a,o,d),_=y,g=v}r&&e.closePath(),s&&(e.strokeStyle=s.color,e.lineWidth=Ft.lineWidth(t)/o,e.stroke()),i&&(r&&null!=l&&null!=u?this._drawSquarePercentFill(e,Lt.fromGeom(f),i,l,u):(e.fillStyle=i.color,e.fill()))}},e.prototype._drawSquarePercentFill=function(t,e,o,n,r){if(0==n)e.h*=r/100;else if(1==n){var i=e.h;e.h*=r/100,e.y+=i-e.h}else if(2==n){var s=e.w;e.w*=r/100,e.x+=s-e.w}else 3==n&&(e.w*=r/100);t.fillStyle=o.color,t.fillRect(e.x,e.y,e.w,e.h)},e.prototype.drawSelected=function(t,e,o,n){var r=Ft.geom(t),i=this.config.renderer.selection,s=Lt.fromGeom(r),c=(i.width+i.lineGap)/o,a=2*c,l=s.x-c,u=s.y-c,f=s.w+a,h=s.h+a;e.dashedRect(l,u,f,h,i.dashLen/o),e.strokeStyle=i.color,e.lineWidth=i.width/o,e.stroke()},e.prototype.contains=function(t,e,o,n){var r=Ft.geom(t);return!!Lt.fromGeom(r).contains(e,o,n)&&(ee.type(t)==Xt.polygon?this.polygonContains(r,t,e,o,n):this.polylineContains(r,t,e,o,n))},e.prototype.polygonContains=function(t,e,o,n,r){for(var i,s,c,a,l,u,f,h,p,d=0,y=t[0],v=t[1],_=y,g=v,m=2;m<=t.length;m+=2){var b=y,S=v;m!=t.length&&(b=t[m],S=t[m+1]),i=_,c=b,void 0,void 0,void 0,void 0,void 0,u=(l=(s=g)>(a=S))?c:i,f=l?a:s,h=l?i:c,p=l?s:a,n!=f&&n!=p||(n+=1e-8),n>p||n<f||o>Math.max(u,h)||!(o<Math.min(u,h)||(u!=o?(n-f)/(o-u):1/0)>=(u!=h?(p-f)/(h-u):1/0))||d++,_=b,g=S}return d%2==1},e.prototype.xxx=function(){return!1},e.prototype.polylineContains=function(t,e,o,n,r){for(var i=t[0],s=t[1],c=2;c<t.length;c+=2){var a=t[c],l=t[c+1],u=a-i,f=l-s,h=(i<a?i:a)-r,p=(i<a?a:i)+r,d=(s<l?s:l)-r,y=(s<l?l:s)+r;if(0==u&&h<=o&&o<=p&&d<=n&&n<=y)return!0;var v=f/u,_=s-v*i,g=v*o+_,m=(n-_)/v;if((n-r<g&&g<n+r||o-r<m&&m<o+r)&&h<=o&&o<=p&&d<=n&&n<=y)return!0;i=a,s=l}return!1},e.prototype.withIn=function(t,e,o,n,r){return!1},e.prototype.handles=function(t){return[]},e.prototype.deltaMove=function(t,e,o){},e.prototype.area=function(t){return 0},e}(Nt),re=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ie=function(t){function e(e){return t.call(this,e)||this}return re(e,t),e.prototype.draw=function(t,e,o,n){var r=Zt.rotation(t)/180*Math.PI,i=Zt.textStyle(t),s=Zt.color(t);s=s&&s.color?s:null;var c=Zt.horizontalStretch(t),a=Zt.height(t),l=i.fontSize*i.scaleFactor;null!=a&&(l=a);var u=l+"px "+i.fontName+" "+(i.fontStyle||""),f=96*l/72,h=null,p=Zt.horizontalAlign(t);p==zt.left?h="start":p==zt.center?h="center":p==zt.right&&(h="end");var d=null,y=Zt.verticalAlign(t);if(y==Ut.top?d="top":y==Ut.center?d="middle":y==Ut.bottom&&(d="bottom"),e.save(),e.translate(Zt.centerPointX(t),Zt.centerPointY(t)),e.rotate(r),e.textAlign=h,e.textBaseline=d,e.font=u,!i.scalable){var v=1/o;e.scale(v,v)}1!=c&&e.scale(c,1);for(var _=Zt.text(t).split("\n"),g=0;g<_.length;++g){var m=_[g],b=f*g;s&&(e.fillStyle=s.color,e.fillText(m,0,b))}e.restore()},e.prototype.drawSelected=function(t,e,o,n){},e.prototype.contains=function(t,e,o,n){return!1},e.prototype.withIn=function(t,e,o,n,r){return!1},e.prototype.handles=function(t){return[]},e.prototype.deltaMove=function(t,e,o){},e.prototype.area=function(t){return 0},e}(Nt),se=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ce=function(t){function e(e){return t.call(this,e)||this}return se(e,t),e.prototype.draw=function(t,e,o){var n=Vt.fillColor(t),r=Vt.lineColor(t);n=n&&n.color?n:null,r=r&&r.color?r:null;var i=Vt.xRadius(t),s=Vt.yRadius(t),c=Vt.rotation(t)/180*Math.PI,a=Vt.startAngle(t),l=Vt.endAngle(t),u=Vt.lineWidth(t),f=s/i;e.save(),e.translate(Vt.centerPointX(t),Vt.centerPointY(t)),e.scale(1,f),e.rotate(c);var h=a/180*Math.PI,p=l/180*Math.PI;e.beginPath(),e.arc(0,0,i,h,p,!0),n&&(e.lineTo(0,0),e.fillStyle=n.color,e.fill()),r&&(e.strokeStyle=r.color,e.lineWidth=u/o,e.stroke()),e.restore()},e.prototype.drawSelected=function(t,e,o){},e.prototype.contains=function(t,e,o,n){return!1},e.prototype.withIn=function(t,e,o,n,r){return!1},e.prototype.handles=function(t){return[]},e.prototype.deltaMove=function(t,e,o){},e.prototype.area=function(t){return t.bounds.area()},e}(Nt),ae=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),le=function(t){function e(e){return t.call(this,e)||this}return ae(e,t),e.prototype.draw=function(t,e,o,n){},e.prototype.drawSelected=function(t,e,o,n){var r=this.config.renderer.selection,i=t.bounds,s=(r.width+r.lineGap)/o,c=2*s,a=i.x-s,l=i.y-s,u=i.w+c,f=i.h+c;e.dashedRect(a,l,u,f,r.dashLen/o),e.strokeStyle=r.color,e.lineWidth=r.width/o,e.stroke()},e.prototype.contains=function(t,e,o,n){return t.bounds.contains(e,o,n)},e.prototype.withIn=function(t,e,o,n,r){return t.bounds.withIn(e,o,n,r)},e.prototype.handles=function(t){return[]},e.prototype.deltaMove=function(t,e,o){},e.prototype.area=function(t){return t.bounds.area()},e}(Nt),ue=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),fe=function(t){function e(e,o,n){var r=t.call(this,e)||this;return r.renderFactory=o,r.dispGroupCache=n,r}return ue(e,t),e.prototype.draw=function(t,e,o,n){var r=this.dispGroupCache.dispGroupForId(t.gid);if(null!=r){var i=t.g[0],s=t.g[1],c=t.r/180*Math.PI,a=t.vs,l=t.hs;e.save(),e.translate(i,s),e.rotate(c),e.scale(a,l);for(var u=0;u<r.length;u++){var f=r[u];this.renderFactory.draw(f,e,o,n)}e.restore()}},e.prototype.drawSelected=function(t,e,o,n){},e.prototype.contains=function(t,e,o,n){return!1},e.prototype.withIn=function(t,e,o,n,r){return!1},e.prototype.handles=function(t){return[]},e.prototype.deltaMove=function(t,e,o){},e.prototype.area=function(t){return 0},e}(Nt),he=function(){function t(t,e){var o=new ne(t),n=new ie(t),r=new ce(t),i=new le(t),s=new fe(t,this,e);this._delegatesByType={DT:n,DPG:o,DPL:o,DE:r,DA:i,DGP:s}}return t.prototype._initBounds=function(t){null==t.bounds&&(t.bounds=Lt.fromGeom(t.g))},t.prototype.draw=function(t,e,o,n){var r=Mt.level(t);r.minZoom<=o&&o<=r.maxZoom&&(null==this._delegatesByType[t._tt]&&console.log(t._tt),this._delegatesByType[t._tt].draw(t,e,o,n))},t.prototype.drawSelected=function(t,e,o,n){this._delegatesByType[t._tt].drawSelected(t,e,o,n)},t.prototype.contains=function(t,e,o,n){return this._initBounds(t),this._delegatesByType[t._tt].contains(t,e,o,n)},t.prototype.withIn=function(t,e,o,n,r){return this._initBounds(t),this._delegatesByType[t._tt].withIn(t,e,o,n,r)},t.prototype.similarTo=function(t,e){return!1},t.prototype.handles=function(t){return this._delegatesByType[t._tt].handles(t)},t.prototype.deltaMove=function(t,e,o){return this._initBounds(t),this._delegatesByType[t._tt].deltaMove(e,o)},t.prototype.area=function(t){return this._initBounds(t),this._delegatesByType[t._tt].area(t)},t.prototype.selectionPriotityCompare=function(t,e){return ee.type(t)==Xt.polygon&&ee.type(e)!=Xt.polygon?1:this._delegatesByType[e._tt].area()-this._delegatesByType[t._tt].area()},t}(),pe=function(){return function(){this.x=0,this.y=0}}(),de=function(){function t(t,e,o,n){this.config=t,this.model=e,this.dispDelegate=o,this.lifecycleEventEmitter=n,this.canvas=null,this.isValid=!1,this.drawEvent=new f.Subject,this._zoom=1,this._pan=new pe}return t.prototype.invalidate=function(){this.isValid=!1},t.prototype.setCanvas=function(t){this.canvas=t,this._init()},t.prototype._init=function(){var t=this;setInterval(function(){return t.draw()},this.config.renderer.drawInterval),this.config.viewPort.zoomChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(e){e!=t._zoom&&t.zoom(e/t._zoom)}),this.config.viewPort.panChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(){return t.pan()}),this.config.canvas.windowChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(){return t.invalidate()}),this.config.renderer.invalidate.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(){return t.invalidate()})},t.prototype.currentViewArea=function(){var t={w:this.canvas.clientWidth/this._zoom,h:this.canvas.clientHeight/this._zoom};return new Lt(this._pan.x-t.w/2,this._pan.y-t.h/2,t.w,t.h)},t.prototype.zoom=function(t){this._zoom*t<this.config.viewPort.minZoom?t=this.config.viewPort.minZoom/this._zoom:this._zoom*t>this.config.viewPort.maxZoom&&(t=this.config.viewPort.maxZoom/this._zoom),this._zoom*=t,this.config.viewPort.zoom=this._zoom,this.config.updateViewPortWindow(this.currentViewArea()),this.invalidate()},t.prototype.pan=function(){var t=this.config.viewPort.pan;this._pan.x=t.x,this._pan.y=t.y,this.config.updateViewPortWindow(this.currentViewArea()),this.invalidate()},t.prototype.draw=function(){if(!this.isValid){this.isValid=!0;var t=this.canvas.getContext("2d"),e=this.model.viewableDisps(),o=this.model.selectedDisps(),n=this.canvas.width/this._zoom,r=this.canvas.height/this._zoom;t.save(),t.translate(this.canvas.width/2,this.canvas.height/2),t.scale(this._zoom,this._zoom),t.translate(-this._pan.x,-this._pan.y),t.fillStyle=this.config.renderer.backgroundColor,t.fillRect(this._pan.x-n,this._pan.y-r,2*n,2*r),this._drawGrid(t);for(var i=0;i<e.length;i++){var s=e[i];this.dispDelegate.draw(s,t,this._zoom,this._pan)}for(i=0;i<o.length;i++){s=o[i];this.dispDelegate.drawSelected(s,t,this._zoom,this._pan)}this.drawEvent.next(t),t.restore()}},t.prototype._drawGrid=function(t){function e(t){return parseInt(t)}if(this.config.renderer.grid.show){var o=this.config.viewPort.window,n=this.config.viewPort.zoom,r=1/n,i=this.config.controller.coordSet.gridSizeForZoom(n),s=o.x,c=o.y,a=o.x+o.w,l=o.y+o.h,u=e(s/i.xGrid),f=e(a/i.xGrid)+1,h=e(c/i.yGrid),p=e(l/i.yGrid)+1;t.lineWidth=this.config.renderer.grid.lineWidth/this._zoom,t.strokeStyle=this.config.renderer.grid.color,t.fillStyle=this.config.renderer.grid.color,t.textAlign="start",t.textBaseline="top",t.font=this.config.renderer.grid.font;for(var d=u;d<f;d++)t.beginPath(),t.moveTo(d*i.xGrid,c),t.lineTo(d*i.xGrid,l),t.stroke();for(var y=h;y<p;y++)t.beginPath(),t.moveTo(s,y*i.yGrid),t.lineTo(a,y*i.yGrid),t.stroke();for(d=u;d<f;d++)for(y=h;y<p;y++){var v=d.toString()+"x"+y.toString();t.save(),t.translate(d*i.xGrid+15,y*i.yGrid+15),t.scale(r,r),t.fillText(v,0,0),t.restore()}}},t.prototype.canvasInnerBounds=function(){var t=this.canvas;return new Lt(0,0,t.width,t.height)},t}(),ye=o("7t+N"),ve=function(){return function(){this.x=0,this.y=0,this.clientX=0,this.clientY=0}}();function _e(t){return t.preventDefault(),!1}var ge=function(){function t(t){this.NAME=t,this._CanvasInput=null,this._lastMousePos=new ve,this.DRAG_START_THRESHOLD=5,this.DRAG_TIME_THRESHOLD=200}return t.prototype._hasPassedDragThreshold=function(t,e){var o=!1;return o=(o=(o=o||e.time.getTime()-t.time.getTime()>this.DRAG_TIME_THRESHOLD)||Math.abs(t.x-e.x)>this.DRAG_START_THRESHOLD)||Math.abs(t.y-e.y)>this.DRAG_START_THRESHOLD},t.prototype.keyDown=function(t){},t.prototype.keyPress=function(t){},t.prototype.keyUp=function(t){},t.prototype.mouseSelectStart=function(t,e){},t.prototype.mouseDown=function(t,e){},t.prototype.mouseMove=function(t,e){},t.prototype.mouseUp=function(t,e){},t.prototype.mouseDoubleClick=function(t,e){},t.prototype.mouseWheel=function(t,e){},t.prototype.touchStart=function(t,e){},t.prototype.touchMove=function(t,e){},t.prototype.touchEnd=function(t,e){},t.prototype.shutdown=function(){},t.prototype.draw=function(t){},t.prototype._setLastMousePos=function(t){var e=t.x-this._lastMousePos.x,o=t.y-this._lastMousePos.y,n=t.clientX-this._lastMousePos.clientX,r=t.clientY-this._lastMousePos.clientY;return this._lastMousePos.x+=e,this._lastMousePos.y+=o,this._lastMousePos.clientX+=n,this._lastMousePos.clientY+=r,{dx:e,dy:o,dClientX:n,dClientY:r}},t}(),me=o("N+Om"),be=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Se=function(t){function e(o,n,r,i){var s=t.call(this,e.TOOL_NAME)||this;return s.canvasInput=o,s.config=n,s.model=r,s.dispDelegate=i,s.STATE_NONE=0,s.STATE_SELECTING=1,s.STATE_DRAG_SELECTING=2,s.STATE_MOVING_RENDERABLE=3,s.STATE_MOVING_HANDLE=4,s.STATE_CANVAS_PANNING=5,s.STATE_CANVAS_ZOOMING=6,s._state=0,s._passedDragThreshold=!1,s._mouseDownOnSelection=!1,s._mouseDownOnCoord=!1,s._mouseDownWithShift=!1,s._mouseDownWithCtrl=!1,s._mouseDownMiddleButton=!1,s._mouseDownRightButton=!1,s._mouseDownOnHandle=null,s._lastPinchDist=null,s._startMousePos=null,s._reset(),s}return be(e,t),e.prototype._reset=function(){this._state=this.STATE_NONE,this._passedDragThreshold=!1,this._mouseDownOnSelection=!1,this._mouseDownOnCoord=!1,this._mouseDownWithShift=!1,this._mouseDownWithCtrl=!1,this._mouseDownMiddleButton=!1,this._mouseDownRightButton=!1,this._mouseDownOnHandle=null,this._lastPinchDist=null,this._startMousePos=null,this._lastMousePos=null},e.prototype.keyUp=function(t){var e=this.config.mouse.phUpDownZoomFactor;if(46==t.keyCode);else if(33==t.keyCode){var o=this.config.viewPort.zoom;o*=1+e/100,this.config.updateViewPortZoom(o)}else if(34==t.keyCode){o=this.config.viewPort.zoom;o*=1-e/100,this.config.updateViewPortZoom(o)}},e.prototype.touchStart=function(t,e){2==t.targetTouches.length?(this._state=this.STATE_CANVAS_ZOOMING,this._lastPinchDist=null):this.mouseDown(t,e)},e.prototype.mouseDown=function(t,e){if(this._mouseDownWithShift=t.shiftKey,this._mouseDownWithCtrl=t.ctrlKey,this._mouseDownMiddleButton=1==t.button,this._mouseDownRightButton=2==t.button,this._startMousePos=e,this._lastMousePos=e,this._mouseDownMiddleButton||this._mouseDownRightButton)this._state=this.STATE_CANVAS_PANNING;else{for(var o=this.model.selectedDisps(),n=o.length-1;n>=0;n--)for(var r=o[n],i=this.dispDelegate.handles(r),s=0;s<i.length;s++){var c=i[s];if(c.contains(e.x,e.y)){this._mouseDownOnHandle={coord:r,handle:c,handleIndex:s};break}}var a=this.config.mouse.selecting.margin;for(n=o.length-1;n>=0;n--){var l=o[n];if(this.dispDelegate.contains(l,e.x,e.y,a)){this._mouseDownOnSelection=!0;break}}if(this._mouseDownOnSelection)this._mouseDownOnCoord=!0;else{var u=this.model.selectableDisps();for(n=u.length-1;n>=0;n--){l=u[n];if(this.dispDelegate.contains(l,e.x,e.y,a)){this._mouseDownOnCoord=!0;break}}}this._mouseDownOnCoord?this._state=this.STATE_SELECTING:(this._state=this.STATE_CANVAS_PANNING,this.model.clearSelection())}},e.prototype.touchMove=function(t,e){this._state==this.STATE_CANVAS_ZOOMING?this._touchZoom(t,e):this.mouseMove(t,e),t.preventDefault()},e.prototype._touchZoom=function(t,e){var o=t.targetTouches[0].pageX,n=t.targetTouches[0].pageY,r=t.targetTouches[1].pageX,i=t.targetTouches[1].pageY,s={clientX:e.clientX,clientY:e.clientY};console.log(s);var c=Math.sqrt((o-r)*(o-r)+(n-i)*(n-i));if(null!=this._lastPinchDist){var a=this._lastPinchDist-c;this._lastPinchDist=c,this._zoomPan(s.clientX,s.clientY,a)}else this._lastPinchDist=c},e.prototype._zoomPan=function(t,e,o){if(o){o*=-1;var n=this.config.viewPort.zoom,r=this.config.viewPort.pan,i=t/n+r.x,s=e/n+r.y;if(n*=1+o/100,this.config.viewPort.minZoom<n&&n<this.config.viewPort.maxZoom){var c=t/n+r.x,a=e/n+r.y,l={x:r.x+(i-c),y:r.y+(s-a)};this.config.updateViewPortPan(l),this.config.updateViewPortZoom(n)}}},e.prototype.mouseMove=function(t,e){if(this._state!=this.STATE_NONE){switch(this._passedDragThreshold=this._passedDragThreshold||this._hasPassedDragThreshold(this._startMousePos,e),this._state==this.STATE_SELECTING&&this._passedDragThreshold&&(this._mouseDownOnSelection?this._state=this.STATE_MOVING_RENDERABLE:this._mouseDownOnCoord?(this._changeSelection(this._selectByPoint(this._startMousePos)),this._state=this.STATE_MOVING_RENDERABLE):this._state=this.STATE_DRAG_SELECTING),this._state){case this.STATE_CANVAS_PANNING:var o=this._setLastMousePos(e),n=this.config.viewPort.pan,r={x:n.x-o.dClientX/this.config.viewPort.zoom,y:n.y-o.dClientY/this.config.viewPort.zoom};this.config.updateViewPortPan(r);break;case this.STATE_DRAG_SELECTING:this._lastMousePos=e;break;case this.STATE_MOVING_RENDERABLE:case this.STATE_MOVING_HANDLE:for(var i=this.model.selectedDisps(),s=(o=this._setLastMousePos(e),i.length-1);s>=0;--s)this.dispDelegate.deltaMove(i[s],o.dx,o.dy);if(0!=i.length){this.config.invalidate();break}if(this._state==this.STATE_MOVING_HANDLE){var c=this._setLastMousePos(e),a=this._mouseDownOnHandle;me(null!=a,"selected handler is null"),a.coord.deltaMoveHandle(c.dx,c.dy,a.handle,a.handleIndex)}}this.config.invalidate()}},e.prototype.touchEnd=function(t,e){this.mouseUp(t,e)},e.prototype.mouseUp=function(t,e){switch(this._state){case this.STATE_SELECTING:case this.STATE_DRAG_SELECTING:var o=[];this._state==this.STATE_SELECTING?o=this._selectByPoint(this._startMousePos):this._state==this.STATE_DRAG_SELECTING?o=this._selectByBox(this._startMousePos,e):me(!1,"Invalid state"),this._changeSelection(o);break;case this.STATE_MOVING_RENDERABLE:case this.STATE_MOVING_HANDLE:for(var n=this.model.selectedDisps().length-1;n>=0;n--)console.log("TODO, Store node move states");console.log("TODO, this.canvasInput._notifyOfChange")}this._reset(),this.config.invalidate()},e.prototype.mouseDoubleClick=function(t,e){var o=this._selectByTypeAndBounds(e);this.model.addSelection(o)},e.prototype.mouseWheel=function(t,e){var o=t.deltaY||t.wheelDelta;15<o&&(o=15),o<-15&&(o=-15),this._zoomPan(e.clientX,e.clientY,o)},e.prototype.draw=function(t){switch(this._state){case this.STATE_DRAG_SELECTING:var e=this.config.viewPort.zoom,o=this._startMousePos.x,n=this._startMousePos.y,r=this._lastMousePos.x-this._startMousePos.x,i=this._lastMousePos.y-this._startMousePos.y;t.strokeStyle=this.config.mouse.selecting.color,t.lineWidth=this.config.mouse.selecting.width/e,t.dashedRect(o,n,r,i,this.config.mouse.selecting.dashLen/e),t.stroke();break;case this.STATE_NONE:}},e.prototype._selectByPoint=function(t){var e=this,o=this.config.mouse.selecting.margin,n=this.model.selectableDisps().filter(function(n){return e.dispDelegate.contains(n,t.x,t.y,o)},this);return n.sort(function(t,o){return e.dispDelegate.selectionPriotityCompare(t,o)}),!this._mouseDownWithCtrl&&n.length&&(n=[n[n.length-1]]),n},e.prototype._selectByBox=function(t,e){var o=this,n=this.model.selectableDisps(),r=Lt.fromGeom([t,e]);return n.filter(function(t){return o.dispDelegate.withIn(t,r.x,r.y,r.w,r.h)})},e.prototype._selectByTypeAndBounds=function(t){var e=this,o=this._selectByPoint(t);if(!o.length)return[];var n=o[o.length-1];return this.model.selectableDisps().filter(function(t){return e.dispDelegate.similarTo(t,n)})},e.prototype._changeSelection=function(t){this._mouseDownOnSelection&&this._mouseDownWithShift?this.model.removeSelection(t):(this._mouseDownWithShift||this.model.clearSelection(),this.model.addSelection(t))},e}(ge),we=function(){function t(t,e,o,n){this.config=t,this.model=e,this.dispDelegate=o,this.lifecycleEventEmitter=n,this._delegate=null,this.canvas=null,this.mouseOffsetX=0,this.mouseOffsetY=0,this.delegateFinished()}return t.prototype.setDelegate=function(t){this._delegate&&this._delegate.shutdown(),this._delegate=new t(this,this.config,this.model,this.dispDelegate),this.config.mouse.currentDelegateName=this._delegate.NAME},t.prototype.delegateFinished=function(){this.setDelegate(Se)},t.prototype._getMouse=function(t){var e=t.pageX,o=t.pageY;if(null==e)if(null!=t.changedTouches&&t.changedTouches.length>=0){var n=t.changedTouches[0];e=n.pageX,o=n.pageY}else console.log("ERROR: Failed to determine pan coordinates");var r=e-this.mouseOffsetX,i=o-this.mouseOffsetY,s=r,c=i,a=this.config.viewPort.zoom,l=this.config.viewPort.pan;return r=r/a+l.x,i=i/a+l.y,isNaN(r)&&console.log("mx IS NaN"),this.config.mouse.currentViewPortPosition={x:r,y:i},this.config.mouse.currentCanvasPosition={x:s,y:c},{x:r,y:i,clientX:s,clientY:c,time:new Date}},t.prototype.setCanvas=function(t){var e=this;this.canvas=t,t.addEventListener("keydown",function(t){e._delegate.keyDown(t)},!0),t.addEventListener("keypress",function(t){e._delegate.keyPress(t)},!0),t.addEventListener("keyup",function(t){e._delegate.keyUp(t)},!0),t.addEventListener("mousedown",function(t){t instanceof MouseEvent&&e._delegate.mouseDown(t,e._getMouse(t))},!0),t.addEventListener("mousemove",function(t){t instanceof MouseEvent&&e._delegate.mouseMove(t,e._getMouse(t))},!0),t.addEventListener("mouseup",function(t){t instanceof MouseEvent&&e._delegate.mouseUp(t,e._getMouse(t))},!0),t.addEventListener("mousewheel",function(t){if(t instanceof MouseEvent)return e._delegate.mouseWheel(t,e._getMouse(t)),t.preventDefault(),!1},!0),t.addEventListener("dblclick",function(t){t instanceof MouseEvent&&e._delegate.mouseDoubleClick(t,e._getMouse(t))},!0),t.addEventListener("selectstart",function(t){return t.preventDefault(),!1},!0),t.addEventListener("contextmenu",_e,!0),t.addEventListener("touchstart",function(t){t instanceof TouchEvent&&(e._delegate.touchStart(t,e._getMouse(t)),_e(t))},!0),t.addEventListener("touchmove",function(t){t instanceof TouchEvent&&(e._delegate.touchMove(t,e._getMouse(t)),_e(t))},!0),t.addEventListener("touchend",function(t){t instanceof TouchEvent&&(e._delegate.touchEnd(t,e._getMouse(t)),_e(t))},!0),this.config.canvas.windowChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(){return e.updateCanvasSize()})},t.prototype.updateCanvasSize=function(){var t=ye(this.canvas),e=this.canvas,o=t.width(),n=t.height(),r=parseInt(t.css("padding-left"))||0,i=parseInt(t.css("padding-top"))||0,s=parseInt(t.css("border-left-width"))||0,c=parseInt(t.css("border-top-width"))||0,a=document.body.parentNode,l=a.offsetTop,u=a.offsetLeft;if(this.mouseOffsetX=0,this.mouseOffsetY=0,null!=e.offsetParent)do{this.mouseOffsetX+=e.offsetLeft,this.mouseOffsetY+=e.offsetTop}while(e=e.offsetParent);this.mouseOffsetX+=r+s+u+o/2,this.mouseOffsetY+=i+c+l+n/2},t.prototype.draw=function(t){this._delegate&&this._delegate.draw(t)},t}();function Oe(){return new Date}var je=function(){function t(t,e,o,n){var r=this;this.config=t,this.gridObservable=e,this.lookupCache=o,this.lifecycleEventEmitter=n,this._coordSetId=null,this._gridBuffer={},this._viewingGridKeysDict={},this._viewingGridKeysStr="",this._visableDisps=[],this._selection=[],this._selectionChangedSubject=new f.Subject,this.needsUpdate=!1,this.needsCompiling=!1,this.isUpdating=!1,this.needsUpdate=!1,setInterval(function(){return r._checkGridKeysForArea()},this.config.controller.updateInterval),setInterval(function(){return r._compileDisps()},this.config.controller.updateInterval),this.gridObservable.observableForCanvas(this.config.canvasId).takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(t){return r._receiveGrid([t])}),this.lifecycleEventEmitter.onDestroyEvent.subscribe(function(){r.gridObservable.unsubscribeCanvas(r.config.canvasId)}),this.config.controller.coordSetChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(t){null==t?(r.config.updateViewPortPan({x:0,y:0}),r.config.updateViewPortZoom(1),r._coordSetId=null):(r.config.updateViewPortPan({x:t.initialPanX,y:t.initialPanY}),r.config.updateViewPortZoom(t.initialZoom),r._coordSetId=t.id),r.reset(),r.needsUpdate=!0}),this.config.viewPort.windowChange.takeUntil(this.lifecycleEventEmitter.onDestroyEvent).subscribe(function(){return r.needsUpdate=!0})}return t.prototype.selectionChangedObservable=function(){return this._selectionChangedSubject},t.prototype.reset=function(){this.needsUpdate=!1,this.isUpdating=!1,this._selection=[],this._visableDisps=[],this._gridBuffer={},this._viewingGridKeysDict={},this._viewingGridKeysStr=""},t.prototype._checkGridKeysForArea=function(){if(null!=this._coordSetId&&this.needsUpdate&&(this.needsUpdate=!1,this.lookupCache.isReady())){var t=this.config.viewPort.window,e=this.config.viewPort.zoom,o=this.config.controller.coordSet.gridKeysForArea(t,e);if(o.join()!=this._viewingGridKeysStr){this._viewingGridKeysStr=o.join(),this._viewingGridKeysDict=function(t){for(var e={},o=0;o<t.length;o++)e[t[o]]=!0;return e}(o);for(var n=0,r=S(this._gridBuffer);n<r.length;n++){var i=r[n];this._viewingGridKeysDict.hasOwnProperty(i)||delete this._gridBuffer[i]}this.gridObservable.updateDiagramWatchedGrids(this.config.canvasId,o)}}},t.prototype._receiveGrid=function(t){for(var e=0,o=t;e<o.length;e++){var n=o[e];if(console.log("PeekCanvasModel: Received grid "+n.gridKey+",  "+n.lastUpdate),n.hasData()&&this._viewingGridKeysDict.hasOwnProperty(n.gridKey)){var r=this._gridBuffer[n.gridKey];null!=r&&r.lastUpdate==n.lastUpdate||(console.log("PeekCanvasModel: Applying grid "+n.gridKey+",  "+n.lastUpdate),this._gridBuffer[n.gridKey]=n,this.needsCompiling=!0)}}},t.prototype.viewableDisps=function(){return this._visableDisps},t.prototype.selectableDisps=function(){return this.viewableDisps().filter(function(t){return Mt.isSelectable(t)})},t.prototype.selectedDisps=function(){return this._selection},t.prototype._compileDisps=function(){if(this.needsCompiling&&(this.needsCompiling=!1,null!=this._coordSetId)){for(var t=Oe(),e=this.lookupCache.levelsOrderedByOrder(this._coordSetId),o=this.lookupCache.layersOrderedByOrder(),n=(this.config.viewPort.zoom,{}),r=[],i={},s=S(this._viewingGridKeysDict),c=0;c<e.length;c++)for(var a=e[c],l=0;l<o.length;l++){var u=o[l];if(u.visible)for(var f=0;f<s.length;f++){var h=s[f],p=this._gridBuffer[h];if(null!=p){var d=n[h];if(null==d&&(d=0),!(d>=p.disps.length)){for(;d<p.disps.length;d++){var y=p.disps[d];if(!(Mt.level(y).order<a.order)){if(a.order<Mt.level(y).order)break;if(!(Mt.layer(y).order<u.order)){if(u.order<Mt.layer(y).order)break;!0!==i[y.id]&&(r.push(y),i[y.id]=!0)}}}n[h]=d}}}}this._visableDisps=r,this.config.model.dispOnScreen=r.length,this.config.invalidate();var v,_=Oe()-t;console.log((v=new Date).toTimeString().split(" ")[0]+"."+v.getUTCMilliseconds()+":  Model: compileDisps took "+_+"ms for "+r.length+" disps and "+s.length+" grids")}},t.prototype.addSelection=function(t){this._selection=this._selection.add(t),this.config.invalidate(),this._selectionChangedSubject.next(this._selection)},t.prototype.removeSelection=function(t){this._selection=this._selection.remove(t),this.config.invalidate(),this._selectionChangedSubject.next(this._selection)},t.prototype.clearSelection=function(){this._selection=[],this.config.invalidate(),this._selectionChangedSubject.next(this._selection)},t}(),Pe=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),xe=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},Re=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Te=function(t){function e(){return t.call(this,o.tupleName)||this}return Pe(e,t),o=e,e.prototype.gridSizeForZoom=function(t){if(null==t)throw new Error("Zoom can't be null");for(var e=0,o=this.gridSizes;e<o.length;e++){var n=o[e];if(n.min<=t&&t<n.max)return n}throw new Error("Unable to determine grid size for zoom "+t)},e.prototype.gridKeysForArea=function(t,e){function o(t){return parseInt(t)}for(var n=this.gridSizeForZoom(e),r=o(t.x/n.xGrid),i=o((t.x+t.w)/n.xGrid)+1,s=o(t.y/n.yGrid),c=o((t.y+t.h)/n.yGrid)+1,a=[],l=r;l<i;l++)for(var u=s;u<c;u++)a.push(this.id.toString()+"|"+n.key+"."+l+"x"+u);return a},e.tupleName=R+"ModelCoordSet",e=o=xe([c.addTupleType,Re("design:paramtypes",[])],e);var o}(c.Tuple),Ee=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1; c>=0; c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},De=this&&this.__metadata||function(t, e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Ce=function(){function t(t){this.tupleService=t,this.modelSetKey="",this._coordSetByKey={},this._coordSetById={},this.subscriptions=[],this._isReady=!1,this.initialLoad()}return t.prototype.initialLoad=function(){var t=this;this.subscriptions.push(this.tupleService.offlineObserver.subscribeToTupleSelector(new c.TupleSelector(Te.tupleName,{})).subscribe(function(e){t._coordSetByKey={};for(var o=0,n=e; o<n.length; o++){var r=n[o];t._coordSetByKey[r.key]=r,t._coordSetById[r.id]=r}}))},t.prototype.shutdown=function(){for(var t=0,e=this.subscriptions; t<e.length; t++){e[t].unsubscribe()}this.subscriptions=[]},t.prototype.isReady=function(){if(this._isReady)return!0;var t=0;for(var e in this._coordSetByKey)t++;return 0!=t&&(this._isReady=!0,!0)},t.prototype.coordSetForKey=function(t){return this._coordSetByKey[t]},t.prototype.coordSetForId=function(t){return this._coordSetById[t]},t=Ee([Object(r.Injectable)(),De("design:paramtypes",[ct])],t)}(),Ie=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Be=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},ke=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Ge=function(e){function n(t,o,n,r,i,s){var c=e.call(this)||this;return c.gridObservable=t,c.lookupCache=o,c.coordSetCache=n,c.dispGroupCache=r,c.itemSelectService=s,c.canvas=null,c.coordSetId=null,c.lastCanvasSize="",c.lastWindowHeight=0,c._privatePosService=i,c.config=new At,c.model=new je(c.config,t,o,c),c.dispDelegate=new he(c.config,r),c.input=new we(c.config,c.model,c.dispDelegate,c),c.renderer=new de(c.config,c.model,c.dispDelegate,c),c.renderer.drawEvent.takeUntil(c.onDestroyEvent).subscribe(function(t){return c.input.draw(t)}),c.connectItemSelectionService(),c.connectDiagramService(),c.connectPositionUpdateNotify(),c}return Ie(n,e),n.prototype.isReady=function(){return this.coordSetCache.isReady()&&this.gridObservable.isReady()&&this.lookupCache.isReady()},n.prototype.ngOnInit=function(){var t=this;this.dispGroupCache.setModelSetKey(this.modelSetKey),this.lookupCache.setModelSetKey(this.modelSetKey),this.canvas=this.canvasView.nativeElement,this.input.setCanvas(this.canvas),this.renderer.setCanvas(this.canvas);var e=ye(this.canvas);ye("body").css("overflow","hidden"),this.doCheckEvent.takeUntil(this.onDestroyEvent).subscribe(function(){var o=ye(window).height();if(t.lastWindowHeight!=o){t.lastWindowHeight=o;var n=o-e.offset().top;e.css("height",n+"px"),e.css("width","100%")}}),this.doCheckEvent.takeUntil(this.onDestroyEvent).subscribe(function(){var o=e.offset(),n=new Lt(o.left,o.top,e.width(),e.height()),r=n.toString();t.lastCanvasSize!=r&&(t.lastCanvasSize=r,t.canvas.height=t.canvas.clientHeight,t.canvas.width=t.canvas.clientWidth,t.config.updateCanvasWindow(n))})},n.prototype.mouseInfo=function(){return this.config.mouse.currentViewPortPosition.x.toFixed(2)+"x"+this.config.mouse.currentViewPortPosition.y.toFixed(2)+"X"+this.config.viewPort.zoom.toFixed(2)+", "+this.config.model.dispOnScreen+" Items"},n.prototype.switchToCoordSet=function(t){if(this.isReady()){var e=this.coordSetCache.coordSetForKey(t);this.config.updateCoordSet(e),this._privatePosService.setTitle("Viewing "+e.name),this.config.updateCoordSet(e),this._privatePosService.setReady(!0)}},n.prototype.connectPositionUpdateNotify=function(){var t=this,e=function(){null!=t.config.controller.coordSet&&t._privatePosService.positionUpdated({coordSetKey:t.config.controller.coordSet.key,x:t.config.viewPort.pan.x,y:t.config.viewPort.pan.y,zoom:t.config.viewPort.zoom})};this.config.viewPort.panChange.takeUntil(this.onDestroyEvent).subscribe(e),this.config.viewPort.zoomChange.takeUntil(this.onDestroyEvent).subscribe(e),this.config.controller.coordSetChange.takeUntil(this.onDestroyEvent).subscribe(e)},n.prototype.connectItemSelectionService=function(){var t=this;this.model.selectionChangedObservable().takeUntil(this.onDestroyEvent).subscribe(function(e){1==e.length&&t.itemSelectService.selectItem({modelSetKey:t.modelSetKey,coordSetKey:t.config.controller.coordSet.key,dispKey:Mt.key(e[0]),dispData:Mt.data(e[0])})})},n.prototype.connectDiagramService=function(){var t=this,e=this.doCheckEvent.takeUntil(this.onDestroyEvent).subscribe(function(){t.isReady()&&(e.unsubscribe(),t._privatePosService.setReady(!0))});this._privatePosService.positionByCoordSetObservable().takeUntil(this.onDestroyEvent).subscribe(function(e){t.isReady()?t.switchToCoordSet(e):console.log("ERROR, Position was called before canvas is ready")}),this._privatePosService.positionObservable().takeUntil(this.onDestroyEvent).subscribe(function(e){null!=t.config.controller.coordSet&&t.config.controller.coordSet.key==e.coordSetKey||t.switchToCoordSet(e.coordSetKey),t.config.updateViewPortPan({x:e.x,y:e.y}),t.config.updateViewPortZoom(e.zoom)})},Be([Object(r.ViewChild)("canvas"),ke("design:type",Object)],n.prototype,"canvasView",void 0),Be([Object(r.Input)("modelSetKey"),ke("design:type",String)],n.prototype,"modelSetKey",void 0),n=Be([Object(r.Component)({selector:"pl-diagram-canvas",template:o("EMtb"),styles:[o("hlov")],moduleId:t.i}),ke("design:paramtypes",[It,ut,Ce,Gt,u,d])],n)}(c.ComponentLifecycleEventEmitter),Le=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Ae=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},Ne=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Me=function(t){function e(){return t.call(this,o.tupleName)||this}return Le(e,t),o=e,e.tupleName=R+"LocationIndexTuple",e=o=Ae([c.addTupleType,Ne("design:paramtypes",[])],e);var o}(c.Tuple),Ke=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Ue=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},ze=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Fe=function(t){function e(){var e=t.call(this,o.tupleName)||this;return e.initialLoadComplete=!1,e.indexBucketUpdateDates={},e}return Ke(e,t),o=e,e.tupleName=R+"LocationIndexUpdateDateTuple",e=o=Ue([c.addTupleType,ze("design:paramtypes",[])],e);var o}(c.Tuple),We=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),Ve=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},He=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Xe=function(t){function e(){return t.call(this,o.tupleName)||this}return We(e,t),o=e,e.fromLocationJson=function(t){var e=new o;return e.coordSetId=t[0],e.dispId=t[1],e.x=t[2],e.y=t[3],e},e.tupleName=R+"DispKeyLocationTuple",e=o=Ve([c.addTupleType,He("design:paramtypes",[])],e);var o}(c.Tuple),Ze=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),qe=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},Ye=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Je=(o("xe4/"),Object(c.extend)({key:"clientLocationIndexWatchUpdateFromDevice"},x)),Qe=function(t){function e(e){return t.call(this,Me.tupleName,{key:e})||this}return Ze(e,t),e}(c.TupleSelector),$e=function(t){function e(e){return t.call(this,Fe.tupleName,{modelSetKey:e})||this}return Ze(e,t),e}(c.TupleSelector);var to=function(){function t(t,e,o,n){this.vortexService=t,this.vortexStatusService=e,this.coordSetService=n,this.indexByModelSet={},this.storage=new c.TupleOfflineStorageService(o,new c.TupleOfflineStorageNameService(I))}return t.prototype.indexForModelSetKey=function(t){var e=null;if(this.indexByModelSet.hasOwnProperty(t)){if((e=this.indexByModelSet[t]).isReady())return Promise.resolve(e)}else e=new eo(this.vortexService,this.vortexStatusService,this.storage,t,this.coordSetService),this.indexByModelSet[t]=e;return new Promise(function(t,o){e.isReadyObservable().first().subscribe(function(){t(e)})})},t=qe([Object(r.Injectable)(),Ye("design:paramtypes",[c.VortexService,c.VortexStatusService,c.TupleStorageFactoryService,Ce])],t)}(),eo=function(){function t(t,e,o,n,r){this.vortexService=t,this.vortexStatusService=e,this.storage=o,this.modelSetKey=n,this.coordSetService=r,this.index=new Fe,this.lifecycleEmitter=new c.ComponentLifecycleEventEmitter,this._hasLoaded=!1,this._hasLoadedSubject=new f.Subject,this.index.modelSetKey=this.modelSetKey,this.initialLoad()}return t.prototype.isReady=function(){return this._hasLoaded},t.prototype.isReadyObservable=function(){return this._hasLoadedSubject},t.prototype.initialLoad=function(){var t=this;this.storage.loadTuples(new $e(this.modelSetKey)).then(function(e){0!=e.length&&(t.index=e[0],t.index.initialLoadComplete&&(t._hasLoaded=!0,t._hasLoadedSubject.next())),t.setupVortexSubscriptions(),t.askServerForUpdates()})},t.prototype.setupVortexSubscriptions=function(){var t=this,e=Object(c.extend)({modelSetKey:this.modelSetKey},Je);this.vortexService.createEndpointObservable(this.lifecycleEmitter,e).takeUntil(this.lifecycleEmitter.onDestroyEvent).subscribe(function(e){t.processLocationIndexesFromServer(e)}),this.vortexStatusService.isOnline.filter(function(t){return 1==t}).takeUntil(this.lifecycleEmitter.onDestroyEvent).subscribe(function(){return t.askServerForUpdates()})},t.prototype.askServerForUpdates=function(){if(this.vortexStatusService.snapshot.isOnline){var t=new Fe;t.indexBucketUpdateDates=this.index.indexBucketUpdateDates;var e=Object(c.extend)({modelSetKey:this.modelSetKey},Je),o=new c.Payload(e,[t]);this.vortexService.sendPayload(o)}},t.prototype.processLocationIndexesFromServer=function(t){var e=this;if(null==t.result||1==t.result)return 1==t.filt.finished?(this.index.initialLoadComplete=!0,void this.storage.saveTuples(new $e(this.modelSetKey),[this.index]).then(function(){e._hasLoaded=!0,e._hasLoadedSubject.next()}).catch(function(t){return console.log("ERROR : "+t)})):void t.decodePayload().then(function(t){return e.storeLocationIndexPayload(t)}).catch(function(t){return"LocationIndexCache.processLocationIndexesFromServer failed: "+t});console.log("ERROR: "+t.result)},t.prototype.storeLocationIndexPayload=function(t){for(var e=this,o=[],n=0,r=t.tuples;n<r.length;n++){var i=r[n];o.push(i)}this.storeLocationIndexTuples(o).then(function(){for(var t=0,n=o;t<n.length;t++){var r=n[t];e.index.indexBucketUpdateDates[r.indexBucket]=r.lastUpdate}return e.storage.saveTuples(new $e(e.modelSetKey),[e.index])}).catch(function(t){return console.log("LocationIndexCache.storeLocationIndexPayload: "+t)})},t.prototype.storeLocationIndexTuples=function(t){return this.storage.transaction(!0).then(function(e){for(var o=[],n=0,r=t;n<r.length;n++){var i=r[n];o.push(e.saveTuplesEncoded(new Qe(i.indexBucket),i.encodedLocationIndexTuple))}return Promise.all(o).then(function(){return e.close()})})},t.prototype.getLocations=function(t){var e=this;if(null==t||0==t.length){return Promise.resolve([])}var o=function(t,e){if(null==t||0==t.length)throw new Error("modelSetkey is None or zero length");if(null==e||0==e.length)throw new Error("dispKey is None or zero length");for(var o=0,n=0;n<e.length;n++)o=(o<<5)-o+e.charCodeAt(n),o|=0;return t+":"+(o&=1023)}(this.modelSetKey,t);return this.index.indexBucketUpdateDates.hasOwnProperty(o)?this.storage.loadTuples(new Qe(o)).then(function(o){if(0==o.length)return[];if(1!=o.length)throw new Error("We received more tuples then expected");for(var n=JSON.parse(o[0].jsonStr),r=null,i=0;i<n.length;i++)if(n[i][0]==t){r=n[i].slice(1);break}if(null==r)return[];for(var s=[],c=0,a=r;c<a.length;c++){var l=a[c],u=Xe.fromLocationJson(l),f=e.coordSetService.coordSetForId(u.coordSetId);null!=f&&(u.coordSetKey=f.key,s.push(u))}return s}):(console.log("DispKey "+t+" doesn't appear in the index"),Promise.resolve([]))},t}(),oo=o("iX8p"),no=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ro=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},io=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},so=function(t){function e(e,o){var n=t.call(this)||this;return n.locationIndexFactoryService=e,n.balloonMsg=o,n.titleUpdatedSubject=new f.Subject,n.positionByCoordSetSubject=new f.Subject,n.positionSubject=new f.Subject,n.positionByKeySubject=new f.Subject,n.isReadySubject=new f.Subject,n.postionUpdatedSubject=new f.Subject,n}return no(e,t),e.prototype.positionByCoordSet=function(t){this.positionByCoordSetSubject.next(t)},e.prototype.position=function(t,e,o,n){this.positionSubject.next({coordSetKey:t,x:e,y:o,zoom:n})},e.prototype.positionByKey=function(t,e,o){var n=this;this.locationIndexFactoryService.indexForModelSetKey(t).then(function(o){o.getLocations(e).then(function(o){0==o.length&&n.balloonMsg.showError("Can not locate disply item "+e+" in model set "+t);var r=o[0];n.positionSubject.next({coordSetKey:r.coordSetKey,x:r.x,y:r.y,zoom:2})})})},e.prototype.canPositionByKey=function(t,e){return this.locationIndexFactoryService.indexForModelSetKey(t).then(function(t){return t.getLocations(e).then(function(t){return 0!=t.length})})},e.prototype.setReady=function(t){this.isReadySubject.next(!0)},e.prototype.setTitle=function(t){this.titleUpdatedSubject.next(t)},e.prototype.positionUpdated=function(t){this.postionUpdatedSubject.next(t)},e.prototype.isReadyObservable=function(){return this.isReadySubject},e.prototype.positionUpdatedObservable=function(){return this.postionUpdatedSubject},e.prototype.titleUpdatedObservable=function(){return this.titleUpdatedSubject},e.prototype.positionObservable=function(){return this.positionSubject},e.prototype.positionByKeyObservable=function(){return this.positionByKeySubject},e.prototype.positionByCoordSetObservable=function(){return this.positionByCoordSetSubject},e=ro([Object(r.Injectable)(),io("design:paramtypes",[to,oo.Ng2BalloonMsgService])],e)}(u),co=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),ao=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},lo=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},uo=function(e){function n(t){var o=e.call(this)||this;return o.lookupCache=t,o}return co(n,e),n.prototype.ngOnInit=function(){},n=ao([Object(r.Component)({selector:"pl-diagram-layer",template:o("xO0c"),moduleId:t.i}),lo("design:paramtypes",[ut])],n)}(c.ComponentLifecycleEventEmitter),fo=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},ho=function(){function t(){}return t=fo([Object(r.NgModule)({imports:[m.b].concat(b.a.FormsModules),exports:[Ge],providers:[Ce,Et,ut,Gt,It,{provide:u,useClass:so},d,to],declarations:[Ge,uo]})],t)}(),po=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),yo=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},vo=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},_o=function(t){function e(){return t.call(this)||this}return po(e,t),o=e,e.initHandler=function(){o.isInitialised||(o.isInitialised=!0,o.iface=window.nsWebViewInterface,o.iface.on("GridLoaderBridge_observable",function(t){var e=(new c.Payload).fromJsonDict(t).tuples;console.log("WEB: Received GridLoaderBridge_observable event"),o.updateSubject.next(e)}),o.iface.on("GridLoaderBridge_isReadyObservable",function(t){console.log("WEB: Received GridLoaderBridge_isReadyObservable event"),o.isReadyVal=t,o.readySubject.next(t)}),o.iface.emit("GridLoaderBridge_start","nothing"))},Object.defineProperty(e.prototype,"observable",{get:function(){return o.updateSubject},enumerable:!0,configurable:!0}),e.prototype.isReady=function(){return o.initHandler(),o.isReadyVal},e.prototype.isReadyObservable=function(){return o.readySubject},e.prototype.cacheAll=function(){throw new Error("Not Implemented")},e.prototype.loadGrids=function(t,e){var n={currentGridUpdateTimes:t,gridKeys:e},r=new c.Payload({},n).toJsonDict();console.log("WEB: Sending GridLoaderBridge_loadGrids event"),o.iface.emit("GridLoaderBridge_loadGrids",r)},e.prototype.watchGrids=function(t){var e=new c.Payload({},t).toJsonDict();console.log("WEB: Sending GridLoaderBridge_watchGrids event"),o.iface.emit("GridLoaderBridge_watchGrids",e)},e.updateSubject=new f.Subject,e.readySubject=new f.Subject,e.isReadyVal=!1,e.isInitialised=!1,e=o=yo([Object(r.Injectable)(),vo("design:paramtypes",[])],e);var o}(Pt),go=o("Hf9m"),mo=o("x2NP"),bo=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),So=function(t){function e(o){var n=t.call(this,o)||this;return e.initHandler(),n}return bo(e,t),e.initHandler=function(){e.isInitialised||(e.isInitialised=!0,window.nsWebViewInterface.on("tupleStoragePromiseFinished",function(t){var o=(new c.Payload).fromJsonDict(t).tuples;console.log("WEB: Received tupleStoragePromiseResolved event"),e.promsById[o.promId][o.action](o.result),delete e.promsById[o.promId]}))},e.prototype.open=function(){return Promise.resolve()},e.prototype.isOpen=function(){return!0},e.prototype.close=function(){},e.prototype.truncateStorage=function(){return console.log("ERROR, TupleStorageBridgeWeb.truncateStorage not implemented."),Promise.resolve()},e.prototype.transaction=function(t){return Promise.resolve(new wo(t))},e.promsById={},e.nextPromiseId=1,e.isInitialised=!1,e}(c.TupleStorageServiceABC),wo=function(){function t(t){this.forWrite=t,this.iface=window.nsWebViewInterface}return t.prototype.loadTuples=function(t){return this.loadTuplesEncoded(t).then(function(t){return null==t?[]:c.Payload.fromEncodedPayload(t).then(function(t){return t.tuples})})},t.prototype.loadTuplesEncoded=function(t){var e=this,o=So.nextPromiseId++;return new Promise(function(n,r){So.promsById[o]={resolve:n,reject:r};var i={promId:o,tupleSelector:t},s=new c.Payload({},i).toJsonDict();console.log("WEB: Sending loadTuplesEncoded event"),e.iface.emit("loadTuplesEncoded",s)})},t.prototype.saveTuples=function(t,e){var o=this;return new c.Payload({},e).toEncodedPayload().then(function(e){return o.saveTuplesEncoded(t,e)})},t.prototype.saveTuplesEncoded=function(t,e){var o=this,n=So.nextPromiseId++;return new Promise(function(r,i){So.promsById[n]={resolve:r,reject:i};var s={promId:n,tupleSelector:t,encodedPayload:e},a=new c.Payload({},s).toJsonDict();console.log("WEB: Sending saveTuplesEncoded event"),o.iface.emit("saveTuplesEncoded",a)})},t.prototype.deleteTuples=function(t){return console.log("ERROR, Transaction.deleteTuples not implemented."),Promise.resolve()},t.prototype.deleteOldTuples=function(t){return console.log("ERROR, Transaction.deleteOldTuples not implemented."),Promise.resolve()},t.prototype.close=function(){return Promise.resolve()},t}(),Oo=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function n(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),jo=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},Po=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},xo=function(t){function e(){return t.call(this,null)||this}return Oo(e,t),e.prototype.create=function(t){return new So(t)},e.prototype.createActionStorage=function(){throw new Error("Action storage not implemented yet")},e=jo([Object(r.Injectable)(),Po("design:paramtypes",[])],e)}(mo.TupleStorageFactoryService),Ro=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s},To=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Eo=function(){function t(t,e,o,n){var r=new c.TupleDataObservableNameService(T,x),i=new c.TupleOfflineStorageNameService(D),s=(new c.TupleActionPushNameService(E,x),new c.TupleOfflineStorageService(o,i));this.tupleOfflineObserver=new c.TupleDataOfflineObserverService(t,e,n,r,s)}return Object.defineProperty(t.prototype,"tupleOfflineAction",{get:function(){throw new Error("offlineAction is not implemented")},enumerable:!0,configurable:!0}),t=Ro([Object(r.Injectable)(),To("design:paramtypes",[c.VortexService,c.VortexStatusService,c.TupleStorageFactoryService,r.NgZone])],t)}(),Do=this&&this.__decorate||function(t,e,o,n){var r,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,n);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(i<3?r(s):i>3?r(e,o,s):r(e,o))||s);return i>3&&s&&Object.defineProperty(e,o,s),s};function Co(){return new go.b([])}var Io=function(){function t(){}return t=Do([Object(r.NgModule)({declarations:[g],imports:[s.a,ho],providers:[{provide:c.TupleStorageFactoryService,useClass:xo},{provide:ct,useClass:Eo},{provide:go.b,useFactory:Co},{provide:Pt,useClass:_o},oo.Ng2BalloonMsgService,c.VortexStatusService,c.VortexService],bootstrap:[g]})],t)}();Object(r.enableProdMode)(),Object(i.a)().bootstrapModule(Io)},xO0c:function(t,e){t.exports='<button class="btn">tb1</button>\n<button class="btn">tb2</button>'}},[0]);